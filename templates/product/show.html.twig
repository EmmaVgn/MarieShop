{% extends "base.html.twig" %}

{% block title %}
	Page de :
	{{ product.name }}
{% endblock %}

{% block body %}
	<div class="container mt-4">
		<h1 class="mb-4">{{ product.name }}</h1>
		<div
			class="row">
			<!-- Galerie d'images du produit -->
			<div class="col-lg-8 mb-4">
				<div id="carouselSingleProductIndicators" class="carousel slide carousel-fade">
					<div class="carousel-inner">
						{% for image in product.images %}
							<div class="carousel-item {% if loop.first %}active{% endif %}">
								<img src="{{ vich_uploader_asset(image, 'imageFile') }}" alt="{{ product.name }}" class="img-fluid">
							</div>
						{% endfor %}
					</div>
					<button class="carousel-control-prev" type="button" data-bs-target="#carouselSingleProductIndicators" data-bs-slide="prev">
						<span class="carousel-control-prev-icon" aria-hidden="true"></span>
						<span class="visually-hidden">Previous</span>
					</button>
					<button class="carousel-control-next" type="button" data-bs-target="#carouselSingleProductIndicators" data-bs-slide="next">
						<span class="carousel-control-next-icon" aria-hidden="true"></span>
						<span class="visually-hidden">Next</span>
					</button>
				</div>
			</div>

			<!-- Détails du produit et ajout au panier -->
			<div class="col-lg-4">
				<div class="card mb-4">
					<div class="card-body text-center">
						<h5 class="card-title">{{ product.name }}</h5>
						<p class="card-text mb-3">
							<span class="fw-bold fs-3">{{ product.price | amount }}</span>
						</p>
						<div class="d-flex justify-content-center align-items-center mb-3">
							<form id="addToCartForm" action="{{ path('cart_add', { id: product.id }) }}" method="get">
								<input type="hidden" name="id" value="{{ product.id }}">
								<div class="d-flex align-items-center me-2">
									<div class="quantity-selector d-flex align-items-center me-2">
										<button type="button" class="btn btn-outline-secondary" id="decrementBtn">-</button>
										<input type="number" id="quantityInput" name="quantity" value="1" min="1" max="{{ product.stock }}" class="form-control mx-2" style="width: 60px;">
										<button type="button" class="btn btn-outline-secondary" id="incrementBtn">+</button>
									</div>
									<div>
										{% if product.stock > 0 %}
											<button type="submit" class="btn btn-success">Ajouter au panier</button>
										{% else %}
											<p class="text-danger">Temporairement en rupture de stock</p>
										{% endif %}
									</div>
								</div>
							</form>
						</div>
						<div class="d-flex justify-content-between mb-3">
							<div class="me-2">
								<strong>Contenance:
								</strong>
								<span class="fs-5 fw-bold">{{ product.capacity }}
									ml</span>
							</div>
							<div>
								<strong>Date Maximum de Durabilité:
								</strong>
								<span class="fs-5 fw-bold">{{ product.MDD | date('Y') }}</span>
							</div>
						</div>
					</div>
				</div>

				<!-- Introduction du produit -->
				<div class="card">
					<div class="card-body text-center">
						<h6 class="card-subtitle mb-2 text-muted">Introduction</h6>
						<p class="card-text">{{ product.introduction }}</p>
					</div>
				</div>
			</div>
		</div>

		<!-- Sections d'informations détaillées -->
		<div class="accordion mt-4" id="accordionExample">
			<div class="accordion-item">
				<h2 class="accordion-header" id="headingOne">
					<button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
						Description détaillée
					</button>
				</h2>
				<div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
					<div class="accordion-body">
						<strong>{{ product.name }}</strong>:
						{{ product.description }}
					</div>
				</div>
			</div>
			<div class="accordion-item">
				<h2 class="accordion-header" id="headingTwo">
					<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
						Indications techniques
					</button>
				</h2>
				<div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionExample">
					<div class="accordion-body">
						<strong>Nom botanique:</strong>
						{{ product.boticalName }}<br>
						<strong>Partie de la plante:</strong>
						{{ product.partofplant }}<br>
						<strong>Méthode d'extraction:</strong>
						{{ product.extractionMethod }}<br>
						<strong>Culture de
							{{ product.name }}:</strong>
						{{ product.culture }}<br>
						<strong>Contenance:</strong>
						{{ product.capacity }}
						ml<br>
						<strong>Date Maximum de Durabilité:</strong>
						{{ product.MDD | date('Y') }}
					</div>
				</div>
			</div>
			<div class="accordion-item">
				<h2 class="accordion-header" id="headingThree">
					<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
						Mode d'utilisation et précautions
					</button>
				</h2>
				<div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#accordionExample">
					<div class="accordion-body">
						<strong>Conseils d'utilisation:</strong>
						{{ product.advise }}<br>
						<strong>Précautions:</strong>
						{{ product.precautions }}
					</div>
				</div>
			</div>
			<div class="mt-4">
				<h2>Avis sur
					{{ product.name }}</h2>
				{% if averageRating > 0 %}
					<div class="mb-3">
						<strong>Note moyenne:</strong>
						<div class="rating">
							{% for i in 1..5 %}
								<span class="star {% if i <= averageRating %}filled{% endif %}">&#9733;</span>
							{% endfor %}
							<span>{{ averageRating | number_format(1) }}/5</span>
						</div>
					</div>
				{% endif %}

				<!-- Slider des avis -->
				<div id="reviewsCarousel" class="carousel slide">
					<div class="carousel-inner">
						{% for comment in comments %}
							<div class="carousel-item {% if loop.first %}active{% endif %}">
								<div class="card mb-3">
									<div class="card-body">
										<h5 class="card-title">{{ comment.fullname }}</h5>
										<div class="rating mb-2">
											{% for i in 1..5 %}
												<span class="star {% if i <= comment.rating %}filled{% endif %}">&#9733;</span>
											{% endfor %}
										</div>
										<p class="card-text">{{ comment.content }}</p>
										<p class="card-text text-muted">{{ comment.createdAt | date('d/m/Y') }}</p>
									</div>
								</div>
							</div>
						{% else %}
							<p>Aucun avis pour ce produit.</p>
						{% endfor %}
					</div>
					<button class="carousel-control-prev" type="button" data-bs-target="#reviewsCarousel" data-bs-slide="prev">
						<span class="carousel-control-prev-icon" aria-hidden="true"></span>
						<span class="visually-hidden">Précédent</span>
					</button>
					<button class="carousel-control-next" type="button" data-bs-target="#reviewsCarousel" data-bs-slide="next">
						<span class="carousel-control-next-icon" aria-hidden="true"></span>
						<span class="visually-hidden">Suivant</span>
					</button>
				</div>
			</div>
			<!-- Formulaire pour laisser un avis -->
			<div class="mt-4">
				{% if is_granted('IS_AUTHENTICATED_FULLY') %}
					<h3>Laisser un avis</h3>
					{{ form_start(commentForm, {'attr': {'class': 'row g-3'}}) }}
					<div class="col-md-12">
						<div class="star-rating mb-3">
							<span>Évaluation :</span>
							{% for i in 1..5 %}
								<i class="far fa-star" data-rating="{{ i }}"></i>
							{% endfor %}
						</div>
						{{ form_widget(commentForm.fullname, {'attr': {'class': 'form-control', 'placeholder': 'Votre nom complet'}}) }}
					</div>
					<div class="col-md-12">
						{{ form_widget(commentForm.content, {'attr': {'class': 'form-control', 'placeholder': 'Votre commentaire'}}) }}
					</div>
					<input type="hidden" name="comment[rating]" id="ratingInput" value="0">
					<div class="col-md-12 text-end">
						<button type="submit" class="btn btn-primary">Envoyer</button>
					</div>
					{{ form_end(commentForm) }}
				{% else %}
					<p>Vous devez être connecté pour laisser un avis.</p>
				{% endif %}
			</div>
		</div>

		<!-- Produits similaires -->
		<div class="mt-4">
			<h2>Produits similaires</h2>
			<div class="row">
				{% for similarProduct in similarProducts %}
					<div class="col-md-3 mb-4">
						<div class="card">
							<img src="{{ vich_uploader_asset(similarProduct.images[0], 'imageFile') }}" class="card-img-top" alt="{{ similarProduct.name }}">
							<div class="card-body">
								<h5 class="card-title">{{ similarProduct.name }}</h5>
								<p class="card-text">
									<strong>{{ similarProduct.price | amount }}</strong>
								</p>
								<a href="{{ path('product_show', { 'category_slug': product.category.slug, 'slug': product.slug }) }}">
									{{ product.name }}
								</a>
								Voir le produit</a>
						</div>
					</div>
				</div>
			{% else %}
				<p>Aucun produit similaire trouvé.</p>
			{% endfor %}
		</div>
	</div>
</div>{% endblock %}{% block javascripts %}
<script src="{{ asset('assets/js/shop.js') }}" defer></script>
<script src="{{ asset('assets/js/bootstrap.bundle.min.js') }}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.11.6/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

<script>
	document.addEventListener('DOMContentLoaded', () => {
const ratingInput = document.querySelector('#ratingInput');
const starRating = document.querySelector('.star-rating');

if (starRating && ratingInput) {
starRating.addEventListener('click', function (event) {
if (event.target.matches('i')) {
const ratingValue = event.target.getAttribute('data-rating');
ratingInput.value = ratingValue;

// Mise à jour des étoiles affichées
starRating.querySelectorAll('i').forEach(function (star) {
const starRatingValue = star.getAttribute('data-rating');
if (starRatingValue <= ratingValue) {
star.classList.remove('far');
star.classList.add('fas');
} else {
star.classList.remove('fas');
star.classList.add('far');
}
});
}
});

// Met à jour l'affichage des étoiles lors du survol
starRating.addEventListener('mouseover', function (event) {
if (event.target.matches('i')) {
const ratingValue = event.target.getAttribute('data-rating');
starRating.querySelectorAll('i').forEach(function (star) {
const starRatingValue = star.getAttribute('data-rating');
if (starRatingValue <= ratingValue) {
star.classList.add('fas');
star.classList.remove('far');
} else {
star.classList.add('far');
star.classList.remove('fas');
}
});
}
});

// Réinitialise les étoiles lors du survol
starRating.addEventListener('mouseout', function () {
const currentRating = ratingInput.value;
starRating.querySelectorAll('i').forEach(function (star) {
const starRatingValue = star.getAttribute('data-rating');
if (starRatingValue <= currentRating) {
star.classList.add('fas');
star.classList.remove('far');
} else {
star.classList.add('far');
star.classList.remove('fas');
}
});
});
}
});

document.addEventListener('DOMContentLoaded', () => {
const reviewsCarousel = document.getElementById('reviewsCarousel');
if (reviewsCarousel) {
new bootstrap.Carousel(reviewsCarousel, {
interval: 5000, // Temps entre chaque slide (en millisecondes)
wrap: true // Permet de faire des boucles infinies
});
}
});
</script>{% endblock %}
